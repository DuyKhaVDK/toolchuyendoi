<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shopee Bulk Converter Pro</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f2f2f7; margin: 0; padding: 15px; display: flex; flex-direction: column; min-height: 100vh; }
        h2 { text-align: center; color: #ee4d2d; margin: 10px 0 20px 0; font-size: 22px; }
        
        .main-container { display: flex; gap: 15px; flex: 1; flex-direction: column; }
        
        .box { 
            display: flex; flex-direction: column; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; 
        }

        .header-box { padding: 12px 15px; background: #fafafa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-weight: 600; color: #333; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }

        .action-group { display: flex; gap: 8px; }
        .icon-btn { border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 5px; transition: background 0.2s; }
        .btn-paste { background-color: #e3f2fd; color: #1976d2; }
        .btn-clear { background-color: #ffebee; color: #c62828; }
        .btn-copy { background-color: #e8f5e9; color: #2e7d32; }
        .icon-btn:active { opacity: 0.7; transform: scale(0.98); }

        textarea { 
            width: 100%; border: none; padding: 15px; font-size: 15px; outline: none; line-height: 1.5; min-height: 150px; font-family: inherit; resize: vertical; 
        }

        /* --- PH·∫¶N SUB ID (M·ªöI) --- */
        .subid-wrapper {
            background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .subid-title { font-weight: 600; font-size: 13px; color: #555; margin-bottom: 10px; display: block;}
        .subid-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .subid-input {
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; text-align: center;
        }
        .subid-input:focus { border-color: #ee4d2d; outline: none; background: #fffdfc; }

        /* Responsive cho SubID tr√™n mobile: Chia l√†m 2 d√≤ng cho d·ªÖ b·∫•m */
        @media (max-width: 480px) {
            .subid-grid { grid-template-columns: repeat(3, 1fr); }
            .subid-input:nth-child(4), .subid-input:nth-child(5) { grid-column: span 1; }
        }

        .controls { margin: 20px 0; }
        button.primary-btn { 
            width: 100%; background-color: #ee4d2d; color: white; border: none; padding: 15px; font-size: 18px; border-radius: 50px; cursor: pointer; font-weight: bold; 
            box-shadow: 0 4px 15px rgba(238, 77, 45, 0.3); transition: transform 0.2s;
        }
        button.primary-btn:active { transform: scale(0.98); background-color: #d73211; }
        button.primary-btn:disabled { background-color: #ccc; box-shadow: none; }

        .debug-section { background: white; padding: 15px; border-radius: 12px; margin-top: 20px; font-size: 12px; display: none;}
        .debug-header { font-weight: bold; margin-bottom: 10px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .debug-row { padding: 10px 0; border-bottom: 1px dashed #eee; display: flex; flex-direction: column; gap: 5px; }
        .lbl { font-weight: bold; color: #777; width: 80px; display: inline-block; }
        .val { word-break: break-all; }
        .val.clean { color: #1976d2; }
        .val.aff { color: #2e7d32; font-weight: bold; }

        @media (min-width: 768px) {
            .main-container { flex-direction: row; }
            .box { flex: 1; }
            button.primary-btn { width: auto; min-width: 250px; margin: 0 auto; display: block; }
        }
    </style>
</head>
<body>

    <h2>Shopee Converter Pro</h2>

    <div class="main-container">
        <div class="box">
            <div class="header-box">
                <span class="header-title">ƒê·∫ßu v√†o</span>
                <div class="action-group">
                    <button class="icon-btn btn-paste" onclick="pasteClipboard()">üìã D√°n</button>
                    <button class="icon-btn btn-clear" onclick="clearInput()">‚úï X√≥a</button>
                </div>
            </div>
            <textarea id="inputText" placeholder="D√°n n·ªôi dung v√†o ƒë√¢y... (K√©o g√≥c d∆∞·ªõi ph·∫£i ƒë·ªÉ ch·ªânh k√≠ch th∆∞·ªõc)"></textarea>
        </div>

        <div class="box">
            <div class="header-box">
                <span class="header-title">K·∫øt qu·∫£</span>
                <button class="icon-btn btn-copy" onclick="copyResult()">Sao ch√©p</button>
            </div>
            <textarea id="outputText" readonly placeholder="Link Affiliate s·∫Ω hi·ªán ·ªü ƒë√¢y..."></textarea>
        </div>
    </div>

    <div class="subid-wrapper" style="margin-top: 15px;">
        <span class="subid-title">G·∫Øn nh√£n theo d√µi (Sub_ID - T√πy ch·ªçn)</span>
        <div class="subid-grid">
            <input type="text" id="sub1" class="subid-input" placeholder="Sub 1">
            <input type="text" id="sub2" class="subid-input" placeholder="Sub 2">
            <input type="text" id="sub3" class="subid-input" placeholder="Sub 3">
            <input type="text" id="sub4" class="subid-input" placeholder="Sub 4">
            <input type="text" id="sub5" class="subid-input" placeholder="Sub 5">
        </div>
    </div>

    <div class="controls">
        <button class="primary-btn" onclick="processText()" id="btnConvert">Chuy·ªÉn ƒë·ªïi ngay</button>
    </div>

    <div class="debug-section" id="debugSection">
        <div class="debug-header">Chi ti·∫øt x·ª≠ l√Ω</div>
        <div id="debugContent"></div>
    </div>

    <script>
        async function pasteClipboard() {
            const inputArea = document.getElementById('inputText');
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    inputArea.value = text;
                    inputArea.style.backgroundColor = "#e3f2fd";
                    setTimeout(() => inputArea.style.backgroundColor = "white", 300);
                } else alert('Clipboard tr·ªëng!');
            } catch (error) {
    console.error(error); // Log ra console ƒë·ªÉ xem
    alert('L·ªói k·∫øt n·ªëi ho·∫∑c x·ª≠ l√Ω: ' + error.message);
}
        }

        function clearInput() {
            document.getElementById('inputText').value = '';
            document.getElementById('inputText').focus();
        }

        let hasCheckedClipboard = false;
        document.getElementById('inputText').addEventListener('focus', async () => {
            if (hasCheckedClipboard) return;
            try {
                const permission = await navigator.permissions.query({ name: 'clipboard-read' });
                if (permission.state === 'granted' || permission.state === 'prompt') {
                    const text = await navigator.clipboard.readText();
                    if (text && (text.includes('shopee.vn') || text.includes('shp.ee'))) {
                        if (confirm('Ph√°t hi·ªán link Shopee. D√°n ngay?')) {
                            document.getElementById('inputText').value = text;
                        }
                    }
                }
            } catch (e) {}
            hasCheckedClipboard = true;
        });

        async function processText() {
            const input = document.getElementById('inputText').value;
            const output = document.getElementById('outputText');
            const btn = document.getElementById('btnConvert');
            const debugSection = document.getElementById('debugSection');
            const debugContent = document.getElementById('debugContent');

            // --- L·∫§Y D·ªÆ LI·ªÜU SUB ID ---
            const subIds = [];
            for (let i = 1; i <= 5; i++) {
                const val = document.getElementById('sub' + i).value.trim();
                if (val) subIds.push(val);
            }
            // --------------------------

            if (!input.trim()) return alert('Vui l√≤ng nh·∫≠p n·ªôi dung!');

            btn.disabled = true; btn.innerText = 'ƒêang x·ª≠ l√Ω...';
            output.value = '';
            debugSection.style.display = 'none';
            debugContent.innerHTML = '';

            try {
                const response = await fetch('/api/convert-text', { 
    method: 'POST',
    // ... gi·ªØ nguy√™n ...
});

                const data = await response.json();

                if (data.success) {
                    output.value = data.newText;
                    
                    if (data.details && data.details.length > 0) {
                        debugSection.style.display = 'block';
                        data.details.forEach(item => {
                            const row = document.createElement('div');
                            row.className = 'debug-row';
                            row.innerHTML = `
                                <div><span class="lbl">G·ªëc:</span> <span class="val">${item.original}</span></div>
                                <div><span class="lbl">S·∫°ch:</span> <span class="val clean">${item.resolved}</span></div>
                                <div><span class="lbl">Affiliate:</span> <span class="val aff">${item.short || 'L·ªói'}</span></div>
                            `;
                            debugContent.appendChild(row);
                        });
                    }
                    if(data.converted === 0) alert('Kh√¥ng t√¨m th·∫•y link Shopee h·ª£p l·ªá.');
                } else {
    // ∆Øu ti√™n hi·ªán data.error, n·∫øu kh√¥ng c√≥ th√¨ hi·ªán to√†n b·ªô data ƒë·ªÉ debug
    const msg = data.error || data.message || JSON.stringify(data);
    alert('L·ªói Server: ' + msg);
}
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi Server.');
            } finally {
                btn.disabled = false; btn.innerText = 'Chuy·ªÉn ƒë·ªïi ngay';
            }
        }

        function copyResult() {
            const copyText = document.getElementById("outputText");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value);
            alert("ƒê√£ sao ch√©p!");
        }
    </script>
</body>
</html>
